@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@model List<ReadAndWatch.Models.Movie>


@functions {
    public string GetMovieImagePath(string title)
    {
        var imageName = title.ToLower()
            .Replace(" ", "-")
            .Replace(":", "")
            .Replace(".", "")
            .Replace("'", "")
            .Replace("!", "")
            + ".jpg";
        return Url.Content("~/images/" + imageName);
    }
}



@{
    ViewData["Title"] = "Ana Sayfa";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    body {
        background-color: #000;
        color: white;
        font-family: 'Segoe UI', sans-serif;
    }

    .search-section {
        margin-top: 120px; /* önceki 60px idi */
        text-align: center;
    }


    .search-box {
        max-width: 600px;
        margin: 0 auto;
    }

    .section-title {
        font-size: 24px;
        margin-top: 50px;
        margin-bottom: 20px;
    }

    .card {
        background-color: #1c1c1c;
        border: none;
        color: white;
        transition: transform 0.2s ease;
    }

        .card:hover {
            transform: scale(1.03);
        }

        .card img {
            border-radius: 8px;
            height: 280px;
            object-fit: cover;
        }

    .auth-buttons {
        margin-top: 20px;
    }
</style>

<div class="search-box">
    <form id="searchForm" class="d-flex">
        <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="Kitap veya film ara..." />
        <button type="submit" class="btn btn-danger ms-2">Ara</button>
    </form>
</div>


<div class="section-title mt-5"></div>
<div id="searchResults" class="row g-4">
    <!-- Arama sonuçları buraya JavaScript ile eklenecek -->
</div>


    @* Giriş yapmayanlar için butonlar — istersen açabilirsin *@
    @* 
    @if (HttpContextAccessor.HttpContext.Session.GetInt32("UserId") == null)
    {
        <div class="auth-buttons">
            <a href="/User/Login" class="btn btn-outline-light me-2">Giriş Yap</a>
            <a href="/User/Register" class="btn btn-danger">Kayıt Ol</a>
        </div>
    }
    *@
</div>

<div class="container">
    <div class="section-title">Trend Filmler</div>
    <div class="row g-4">
        @foreach (var movie in Model)
        {
            <div class="col-md-2">
                <a asp-controller="Movie" asp-action="Details" asp-route-id="@movie.Id" style="text-decoration:none; color:inherit">
                    <div class="card h-100">
                        <img src="@GetMovieImagePath(movie.Title)"
                             onerror="this.onerror=null; this.src='@Url.Content("~/images/movie-poster.jpg")';"
                             class="card-img-top"
                             alt="@movie.Title" />

                        <div class="card-body text-center">
                            <h6 class="card-title">@movie.Title</h6>
                            <p class="card-text text-muted">@movie.ReleaseDate?.ToString("yyyy")</p>
                        </div>
                    </div>
                </a>
            </div>
        }
    </div>


    <div class="section-title">Trend Kitaplar</div>
    <div class="row g-4">
        @foreach (var book in (List<ReadAndWatch.Models.Book>)ViewBag.TrendBooks)
        {
            <div class="col-md-2">
                <a asp-controller="Book" asp-action="Details" asp-route-id="@book.Id" style="text-decoration:none; color:inherit">
                    <div class="card h-100">
                        <img src="@(string.IsNullOrEmpty(book.Thumbnail) ? Url.Content("~/images/book-placeholder.jpg") : book.Thumbnail)" class="card-img-top" alt="@book.Title" />


                        <div class="card-body text-center">
                            <h6 class="card-title">@book.Title</h6>
                            <p class="card-text text-muted">Puan: @book.AverageRating</p>
                        </div>
                    </div>
                </a>
            </div>
        }
    </div>



    @section Scripts {
        <script>
            document.getElementById("searchForm").addEventListener("submit", async function (e) {
                e.preventDefault();

                const query = document.getElementById("searchInput").value.trim();
                if (!query) return;

                const response = await fetch(`/Home/SearchJson?query=${encodeURIComponent(query)}`);
                const data = await response.json();

                const container = document.getElementById("searchResults");
                container.innerHTML = "";

                if (data.books.length === 0 && data.movies.length === 0) {
                    container.innerHTML = "<p class='text-light'>Sonuç bulunamadı.</p>";
                    return;
                }

                data.books.forEach(book => {
                    container.innerHTML += `
                        <div class="col-md-2">
                            <a href="/Book/Details/${book.id}" style="text-decoration:none; color:inherit">
                                <div class="card h-100 bg-dark text-white">
                                    <img src="${book.thumbnail || '/images/book-placeholder.jpg'}" class="card-img-top" style="height:260px; object-fit:cover;" />
                                    <div class="card-body text-center">
                                        <h6 class="card-title">${book.title}</h6>
                                        <p class="card-text">Yazar: ${book.authors || '-'}</p>
                                    </div>
                                </div>
                            </a>
                        </div>`;
                });

                data.movies.forEach(movie => {
                    container.innerHTML += `
                        <div class="col-md-2">
                            <a href="/Movie/Details/${movie.id}" style="text-decoration:none; color:inherit">
                                <div class="card h-100 bg-dark text-white">
                                    <img src="/images/movie-poster.jpg" class="card-img-top" style="height:260px; object-fit:cover;" />
                                    <div class="card-body text-center">
                                        <h6 class="card-title">${movie.title}</h6>
                                        <p class="card-text">${movie.overview?.substring(0, 100) || 'Açıklama bulunamadı'}...</p>
                                    </div>
                                </div>
                            </a>
                        </div>`;
                });
            });
        </script>
    }



</div>
